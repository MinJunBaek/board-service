<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"/>
    <title>Main Page</title>
  </head>

  <body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- 게시글 제목 영역 -->
    <div class="container py-4">
      <div class="mb-4">
        <h2 th:text="${post.title}">제목</h2>
        <div class="text-muted small">
          <span th:text="'작성자 : ' + ${post.memberName}">작성자</span>
          &nbsp;|&nbsp;
          <span th:text="'작성일 : ' + ${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
          &nbsp;|&nbsp;
          <span th:text="'조회수 : ' + ${post.viewCount}">조회수</span>
        </div>
      </div>

      <!-- 게시글 내용 -->
      <div class="mb-4 border rounded p-3" style="min-height: 150px;">
        <p th:utext="${#strings.replace(post.content, '\n', '<br/>')}">
          내용
        </p>
      </div>

      <!-- 상단 버튼 영역 : 좋아요 + (작성자 전용) 수정/삭제 -->
      <div class="d-flex justify-content-between align-items-center mb-4">

        <!-- 좋아요 버튼 (로그인한 경우에만 보여주고 싶으면 th:if 로 감싸기) -->
        <form th:action="@{|/posts/${post.id}/like|}" method="post" class="d-inline">
          <button type="submit" class="btn btn-outline-primary">
            👍 좋아요
            <span th:text="${post.likeCount}">0</span>
          </button>
        </form>

        <!-- 작성자만: 수정/삭제 버튼 -->
        <div th:if="${isPostAuthor}">
          <a th:href="@{|/posts/${post.id}/edit-form|}" class="btn btn-secondary me-2">
            수정
          </a>

          <form th:action="@{|/posts/${post.id}|}" method="post" class="d-inline">
            <!-- HiddenHttpMethodFilter 사용 시 -->
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" class="btn btn-danger">
              삭제
            </button>
          </form>
        </div>
      </div>

      <hr/>

      <!-- 댓글 작성 폼 -->
      <div class="mb-4">
        <h5>댓글 작성</h5>

        <!-- 로그인한 사람만 댓글 작성 가능 -->
        <div th:if="${memberId != null}">
          <form th:action="@{|/posts/${post.id}/comments|}" method="post">
            <div class="mb-3">
            <textarea class="form-control" name="content" rows="3"
                      placeholder="댓글을 입력하세요" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">댓글 등록</button>
          </form>
        </div>

        <div th:if="${memberId == null}">
          <p class="text-muted">
            댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.
          </p>
        </div>
      </div>

      <hr/>

      <!-- 댓글 리스트 -->
      <div>
        <h5>댓글 목록</h5>

        <div th:if="${#lists.isEmpty(comments)}">
          <p class="text-muted">등록된 댓글이 없습니다.</p>
        </div>

        <div th:each="comment : ${comments}" class="border-bottom py-3">
          <div class="d-flex justify-content-between">
            <div>
              <strong th:text="${comment.memberName}">작성자</strong>
              <span class="text-muted small"
                    th:text="${#temporals.format(comment.updatedAt, 'yyyy-MM-dd HH:mm')}">
              날짜
            </span>
            </div>

            <!-- 댓글 작성자만 수정/삭제 -->
            <div th:if="${loggedIn != null and memberId == comment.memberId}">
              <!-- 댓글 수정 페이지로 이동 or JS로 토글해서 inline 수정도 가능 -->
              <a th:href="@{|/posts/${post.id}/comments/${comment.id}/edit-form|}"
                 class="btn btn-sm btn-outline-secondary me-1">
                수정
              </a>

              <form th:action="@{|/posts/${post.id}/comments/${comment.id}|}"
                    method="post" class="d-inline">
                <input type="hidden" name="_method" value="delete" />
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  삭제
                </button>
              </form>
            </div>
          </div>

          <div class="mt-2">
            <p th:utext="${#strings.replace(comment.content, '\n', '<br/>')}"></p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"
    ></script>
  </body>
</html>