<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"/>

    <title th:text="${post.title}">ê²Œì‹œê¸€ ìƒì„¸</title>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- ëŒ“ê¸€ inline ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
      document.addEventListener("DOMContentLoaded", function () {
        const postId = /*[[${post.id}]]*/ 0;

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = csrfTokenMeta ? csrfTokenMeta.content : null;
        const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.content : null;

        // ìˆ˜ì • ë²„íŠ¼ â†’ ìˆ˜ì • ëª¨ë“œ
        document.querySelectorAll(".comment-edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const commentId = btn.dataset.commentId;
            const root = document.querySelector(
              `.comment-item[data-comment-id="${commentId}"]`
            );
            if (!root) return;

            const viewArea = root.querySelector(".comment-view");
            const editArea = root.querySelector(".comment-edit-area");
            const textarea = root.querySelector(".comment-edit-input");

            textarea.value = viewArea.innerText.trim();

            viewArea.classList.add("d-none");
            editArea.classList.remove("d-none");
          });
        });

        // ì·¨ì†Œ ë²„íŠ¼ â†’ ì›ë˜ëŒ€ë¡œ
        document.querySelectorAll(".comment-cancel-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const root = btn.closest(".comment-item");
            const viewArea = root.querySelector(".comment-view");
            const editArea = root.querySelector(".comment-edit-area");

            editArea.classList.add("d-none");
            viewArea.classList.remove("d-none");
          });
        });

        // ì €ì¥ ë²„íŠ¼ â†’ PATCH í˜¸ì¶œ
        document.querySelectorAll(".comment-save-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const commentId = btn.dataset.commentId;
            const root = document.querySelector(
              `.comment-item[data-comment-id="${commentId}"]`
            );
            if (!root) return;

            const textarea = root.querySelector(".comment-edit-input");
            const newContent = textarea.value.trim();
            if (!newContent) {
              alert("ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
              return;
            }

            try {
              const headers = {
                "Content-Type": "application/json",
              };
              if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
              }

              const response = await fetch(
                `/posts/${postId}/comments/${commentId}`,
                {
                  method: "PATCH",
                  headers,
                  body: JSON.stringify({ content: newContent }),
                }
              );

              if (!response.ok) {
                alert("ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
              }

              const api = await response.json();
              // Api.success(code, message, data) êµ¬ì¡°ë¼ë©´ ì´ê²Œ ì •ì„
              const updated = api.data ?? api;

              const viewArea = root.querySelector(".comment-view");
              const contentP = viewArea.querySelector("p");
              contentP.innerHTML = newContent.replace(/\n/g, "<br/>");

              const dateSpan = root.querySelector(".comment-date");
              if (updated && updated.updatedAt) {
                const formatted = updated.updatedAt
                  .substring(0, 16)
                  .replace("T", " ");
                dateSpan.innerText = formatted;
              }

              root.querySelector(".comment-edit-area").classList.add("d-none");
              viewArea.classList.remove("d-none");
            } catch (e) {
              console.error(e);
              alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        });
      });
    </script>
  </head>

  <body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- ê²Œì‹œê¸€ ì œëª© ì˜ì—­ -->
    <div class="container py-4">
      <div class="mb-4">
        <h2 th:text="${post.title}">ì œëª©</h2>
        <div class="text-muted small">
          <span th:text="'ì‘ì„±ì : ' + ${post.memberName}">ì‘ì„±ì</span>
          &nbsp;|&nbsp;
          <span th:text="'ì‘ì„±ì¼ : ' + ${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
          &nbsp;|&nbsp;
          <span th:text="'ì¡°íšŒìˆ˜ : ' + ${post.viewCount}">ì¡°íšŒìˆ˜</span>
        </div>
      </div>

      <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
      <div class="mb-4 border rounded p-3" style="min-height: 150px;">
        <p th:utext="${#strings.replace(post.content, '\n', '<br/>')}">
          ë‚´ìš©
        </p>
      </div>

      <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ : ì¢‹ì•„ìš” + (ì‘ì„±ì ì „ìš©) ìˆ˜ì •/ì‚­ì œ -->
      <div class="d-flex justify-content-between align-items-center mb-4">

        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ (ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ th:if ë¡œ ê°ì‹¸ê¸°) -->
        <form th:action="@{|/posts/${post.id}/like|}" method="post" class="d-inline">
          <button type="submit" class="btn btn-outline-primary">
            ğŸ‘ ì¢‹ì•„ìš”
            <span th:text="${post.likeCount}">0</span>
          </button>
        </form>

        <!-- ì‘ì„±ìë§Œ: ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
        <div th:if="${isPostAuthor}">
          <a th:href="@{|/posts/${post.id}/posts-edit-form|}" class="btn btn-secondary me-2">
            ìˆ˜ì •
          </a>

          <form th:action="@{|/boards/${post.boardId}/posts/${post.id}|}" method="post" class="d-inline">
            <!-- HiddenHttpMethodFilter ì‚¬ìš© ì‹œ -->
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" class="btn btn-outline-danger">
              ì‚­ì œ
            </button>
          </form>
        </div>
      </div>

      <hr/>

      <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
      <div class="mb-4">
        <h5>ëŒ“ê¸€ ì‘ì„±</h5>

        <!-- ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥ -->
        <div th:if="${memberId != null}">
          <form th:action="@{|/posts/${post.id}/comments|}" method="post">
            <div class="mb-3">
            <textarea class="form-control" name="content" rows="3"
                      placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ë“±ë¡</button>
          </form>
        </div>

        <div th:if="${memberId == null}">
          <p class="text-muted">
            ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/login}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
          </p>
        </div>
      </div>

      <hr/>

      <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
      <div>
        <h5>ëŒ“ê¸€ ëª©ë¡</h5>

        <div th:if="${#lists.isEmpty(comments)}">
          <p class="text-muted">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div th:each="comment : ${comments}"
             class="border-bottom py-3 comment-item"
             th:attr="data-comment-id=${comment.id}">
          <div class="d-flex justify-content-between">
            <div>
              <strong th:text="${comment.memberName}">ì‘ì„±ì</strong>
              <span class="text-muted small comment-date"
                    th:text="${#temporals.format(comment.updatedAt, 'yyyy-MM-dd HH:mm')}">
          ë‚ ì§œ
        </span>
            </div>

            <!-- ëŒ“ê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ -->
            <div th:if="${loggedIn != null and memberId == comment.memberId}">
              <!-- ìˆ˜ì •: JSë¡œ inline ìˆ˜ì • -->
              <button type="button"
                      class="btn btn-sm btn-outline-secondary me-1 comment-edit-btn"
                      th:attr="data-comment-id=${comment.id}">
                ìˆ˜ì •
              </button>

              <!-- ì‚­ì œ (í˜ì´ì§€ ë°©ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
              <form th:action="@{|/posts/${post.id}/comments/${comment.id}|}"
                    method="post" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  ì‚­ì œ
                </button>
              </form>
            </div>
          </div>

          <div class="mt-2">
            <!-- ë³´ê¸° ëª¨ë“œ -->
            <div class="comment-view">
              <p th:utext="${#strings.replace(comment.content, '\n', '<br/>')}"></p>
            </div>

            <!-- ìˆ˜ì • ëª¨ë“œ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
            <div class="comment-edit-area d-none">
        <textarea class="form-control comment-edit-input" rows="3"
                  th:text="${comment.content}"></textarea>
              <div class="mt-2">
                <button type="button"
                        class="btn btn-sm btn-primary comment-save-btn"
                        th:attr="data-comment-id=${comment.id}">
                  ì €ì¥
                </button>
                <button type="button"
                        class="btn btn-sm btn-secondary comment-cancel-btn">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"
    ></script>
  </body>
</html>